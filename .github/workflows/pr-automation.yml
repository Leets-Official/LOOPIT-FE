name: PR Automation

on:
  pull_request:
    types: [opened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  auto-setup:
    runs-on: ubuntu-latest
    steps:
      - name: Auto assign and add reviewers
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prAuthor = context.payload.pull_request.user.login;
            const branchName = context.payload.pull_request.head.ref;
            const currentAssignees = context.payload.pull_request.assignees || [];
            const currentReviewers = context.payload.pull_request.requested_reviewers || [];

            // Assignee ì„¤ì •
            if (currentAssignees.length === 0) {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                assignees: [prAuthor]
              });
            }

            // Reviewer ì¶”ê°€
            if (currentReviewers.length === 0) {
              const reviewers = ['YeBeenChoi', 'jwj0620gcu'].filter(r => r !== prAuthor);
              if (reviewers.length > 0) {
                try {
                  await github.rest.pulls.requestReviewers({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: prNumber,
                    reviewers: reviewers
                  });
                } catch (error) {
                  console.log('Failed to add reviewers:', error.message);
                }
              }
            }

            // ë¸Œëœì¹˜ëª…ì—ì„œ ë¼ë²¨ ì¶”ì¶œ ë° ì¶”ê°€
            const labelMatch = branchName.match(/(?:^\d+-)?(\w+)\//);
            if (labelMatch) {
              const labelMap = {
                'feat': 'âœ¨Feature',
                'fix': 'ğŸ›BugFix',
                'hotfix': 'ğŸš¨Hotfix',
                'refactor': 'â™»ï¸Refactor',
                'test': 'âœ…Test',
                'docs': 'ğŸ“Docs',
                'chore': 'ğŸ› ï¸ Chore'
              };
              const labelToAdd = labelMap[labelMatch[1].toLowerCase()];

              if (labelToAdd) {
                try {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: prNumber,
                    labels: [labelToAdd]
                  });
                } catch (error) {
                  console.log('Failed to add label:', error.message);
                }
              }
            }
