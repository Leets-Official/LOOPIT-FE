name: Auto Create Branch

on:
  issues:
    types: [opened]

jobs:
  create-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Extract branch name from issue form
        id: extract
        run: |
          # Issue bodyë¥¼ íŒŒì¼ë¡œ ì €ì¥ (íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬)
          cat << 'EOF' > issue_body.txt
          ${{ github.event.issue.body }}
          EOF

          # ì´ìŠˆ ì œëª© ì €ì¥
          ISSUE_TITLE="${{ github.event.issue.title }}"
          echo "í˜„ì¬ ì´ìŠˆ ì œëª©: $ISSUE_TITLE"

          # ë¸Œëœì¹˜ëª… ì¶”ì¶œ ("ë¸Œëœì¹˜ëª…" ë˜ëŠ” "Branch" ì„¹ì…˜)
          BRANCH_NAME=$(grep -A 2 "ë¸Œëœì¹˜ëª…\|Branch" issue_body.txt | tail -1 | xargs)

          # ë¸Œëœì¹˜ëª… ì¬ì¶”ì¶œ (ë¹ˆ ì¤„ì´ë‚˜ í—¤ë”ê°€ ì¶”ì¶œëœ ê²½ìš°)
          if [ -z "$BRANCH_NAME" ] || [[ "$BRANCH_NAME" == "###"* ]] || [[ "$BRANCH_NAME" == "ğŸŒ³"* ]]; then
            BRANCH_NAME=$(sed -n '/Branch/,/###/{/Branch/n; /###/!p;}' issue_body.txt | grep -v "^$" | head -1 | xargs)
          fi

          # ë¸Œëœì¹˜ íƒ€ì… ì¶”ì¶œ ("ë¸Œëœì¹˜ íƒ€ì…" ë˜ëŠ” "branchType" ì„¹ì…˜)
          BRANCH_TYPE=$(grep -A 2 "ë¸Œëœì¹˜ íƒ€ì…\|branchType" issue_body.txt | tail -1 | xargs)

          # ë¸Œëœì¹˜ íƒ€ì… ì¬ì¶”ì¶œ (ë¹ˆ ì¤„ì´ë‚˜ í—¤ë”ê°€ ì¶”ì¶œëœ ê²½ìš°)
          if [ -z "$BRANCH_TYPE" ] || [[ "$BRANCH_TYPE" == "###"* ]] || [[ "$BRANCH_TYPE" == "ğŸ“‚"* ]]; then
            BRANCH_TYPE=$(sed -n '/ë¸Œëœì¹˜ íƒ€ì…/,/###/{/ë¸Œëœì¹˜ íƒ€ì…/n; /###/!p;}' issue_body.txt | grep -v "^$" | head -1 | xargs)
          fi

          echo "ì¶”ì¶œëœ ë¸Œëœì¹˜ íƒ€ì…: $BRANCH_TYPE"

          # ì´ìŠˆ ì œëª© ìƒì„± ([Type] #ë²ˆí˜¸ - ì œëª© í˜•ì‹)
          if [ -n "$BRANCH_TYPE" ] && [ -n "$ISSUE_TITLE" ]; then
            if [[ ! "$ISSUE_TITLE" =~ ^\[.*\] ]]; then
              # íŒŒìŠ¤ì¹¼ì¼€ì´ìŠ¤ ë³€í™˜
              BRANCH_TYPE_PASCAL=$(echo "$BRANCH_TYPE" | sed 's/\b\(.\)/\u\1/')
              NEW_ISSUE_TITLE="[${BRANCH_TYPE_PASCAL}] #${{ github.event.issue.number }} - ${ISSUE_TITLE}"
              echo "ìƒˆë¡œìš´ ì´ìŠˆ ì œëª©: $NEW_ISSUE_TITLE"
            else
              NEW_ISSUE_TITLE="$ISSUE_TITLE"
              echo "ì´ìŠˆ ì œëª©ì— ì´ë¯¸ íƒ€ì…ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
            fi
          else
            NEW_ISSUE_TITLE="$ISSUE_TITLE"
          fi

          # ë¸Œëœì¹˜ëª… ìƒì„±
          if [ -z "$BRANCH_NAME" ]; then
            echo "ë¸Œëœì¹˜ëª…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ ì‚¬ìš©."
            BRANCH_NAME="issue-${{ github.event.issue.number }}"
          else
            # Git ë¸Œëœì¹˜ëª… ê·œì¹™ì— ë§ê²Œ ì •ì œ (í•œê¸€ í—ˆìš©)
            # 1. ê³µë°±ì„ í•˜ì´í”ˆìœ¼ë¡œ ë³€ê²½
            BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/ /-/g')

            # 2. Git ë¹„í—ˆìš© íŠ¹ìˆ˜ë¬¸ì ì œê±° (:, ^, ~, ?, *, [, \, .., @{)
            BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[:^~?*\[\\]//g; s/\.\.//g; s/@{//g')

            # 3. ì—°ì†ëœ í•˜ì´í”ˆ/ìŠ¬ë˜ì‹œ ì œê±°
            BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/--*/-/g; s/\/\/*\//\//g')

            # 4. ì•ë’¤ í•˜ì´í”ˆ/ìŠ¬ë˜ì‹œ/ì  ì œê±°
            BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/^[-\/\.]*//; s/[-\/\.]*$//')

            # 5. ë¹ˆ ë¬¸ìì—´ ê²€ì¦
            if [ -z "$BRANCH_NAME" ]; then
              echo "ì •ì œ í›„ ë¸Œëœì¹˜ëª…ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ ì‚¬ìš©."
              BRANCH_NAME="issue-${{ github.event.issue.number }}"
            else
              # ë¸Œëœì¹˜ íƒ€ì… prefix ì¶”ê°€ (type/)
              if [ -n "$BRANCH_TYPE" ]; then
                if [[ ! "$BRANCH_NAME" =~ ^$BRANCH_TYPE/ ]]; then
                  BRANCH_NAME="${BRANCH_TYPE}/${BRANCH_NAME}"
                fi
              fi

              # ì´ìŠˆë²ˆí˜¸ prefix ì¶”ê°€ (ë²ˆí˜¸-)
              BRANCH_NAME="${{ github.event.issue.number }}-$BRANCH_NAME"
            fi
          fi

          echo "ìµœì¢… ë¸Œëœì¹˜ëª…: $BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "new_issue_title=$NEW_ISSUE_TITLE" >> $GITHUB_OUTPUT
          echo "branch_type=$BRANCH_TYPE" >> $GITHUB_OUTPUT

          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f issue_body.txt

      - name: Update issue title and labels
        run: |
          NEW_TITLE="${{ steps.extract.outputs.new_issue_title }}"
          BRANCH_TYPE="${{ steps.extract.outputs.branch_type }}"

          # ë¸Œëœì¹˜ íƒ€ì…ë³„ ì´ëª¨ì§€ ë¼ë²¨ ë§¤í•‘
          case "$BRANCH_TYPE" in
            "feat")     LABEL="âœ¨Feature" ;;
            "fix")      LABEL="ğŸ›BugFix" ;;
            "hotfix")   LABEL="ğŸš¨Hotfix" ;;
            "refactor") LABEL="â™»ï¸Refactor" ;;
            "test")     LABEL="âœ…Test" ;;
            "docs")     LABEL="ğŸ“Docs" ;;
            "chore")    LABEL="ğŸ› ï¸ Chore" ;;
            *)          LABEL="$BRANCH_TYPE" ;;
          esac

          # ì´ìŠˆ ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ (ì œëª©, ë¼ë²¨, ë‹´ë‹¹ì)
          if [ -n "$NEW_TITLE" ] && [ -n "$LABEL" ]; then
            curl -X PATCH \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }} \
              -d "{\"title\":\"$NEW_TITLE\",\"labels\":[\"$LABEL\"],\"assignees\":[\"${{ github.event.issue.user.login }}\"]}"

            echo "ì´ìŠˆ ì œëª© ì—…ë°ì´íŠ¸: $NEW_TITLE"
            echo "ë¼ë²¨ ì„¤ì •: $LABEL"
            echo "ë‹´ë‹¹ì í• ë‹¹: ${{ github.event.issue.user.login }}"
          fi

      - name: Create branch
        run: |
          BRANCH_NAME="${{ steps.extract.outputs.branch_name }}"

          # Git ì„¤ì •
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Main ë¸Œëœì¹˜ ê¸°ë°˜ìœ¼ë¡œ ìƒˆ ë¸Œëœì¹˜ ìƒì„±
          git checkout main
          git pull origin main

          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"

          echo "ë¸Œëœì¹˜ '$BRANCH_NAME' ìƒì„± ì™„ë£Œ"

      - name: Add comment to issue
        env:
          BRANCH_NAME: ${{ steps.extract.outputs.branch_name }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ì´ìŠˆì— ë¸Œëœì¹˜ ìƒì„± ì•Œë¦¼ ëŒ“ê¸€ ì¶”ê°€
          COMMENT=$(cat <<EOF
          ğŸŒ¿ ë¸Œëœì¹˜ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!

          \`\`\`
          $BRANCH_NAME
          \`\`\`
          EOF
          )

          gh issue comment ${{ github.event.issue.number }} --body "$COMMENT"

          echo "ì´ìŠˆì— ëŒ“ê¸€ ì¶”ê°€ ì™„ë£Œ"
