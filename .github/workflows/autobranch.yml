name: ìë™ ë¸Œëœì¹˜ ìƒì„±

on:
  issues:
    types: [opened]

jobs:
  create-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Extract branch name from issue form
        id: extract
        run: |
          # issue bodyë¥¼ íŒŒì¼ë¡œ ì €ì¥ (íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬)
          cat << 'EOF' > issue_body.txt
          ${{ github.event.issue.body }}
          EOF

          # GitHub ê¸°ë³¸ ì œëª© ì‚¬ìš©
          ISSUE_TITLE="${{ github.event.issue.title }}"
          echo "í˜„ì¬ ì´ìŠˆ ì œëª©: $ISSUE_TITLE"

          # "ë¸Œëœì¹˜ëª…" ë˜ëŠ” "Branch" ì„¹ì…˜ì—ì„œ ê°’ ì¶”ì¶œ
          BRANCH_NAME=$(grep -A 2 "ë¸Œëœì¹˜ëª…\|Branch" issue_body.txt | tail -1 | xargs)

          # ë¹ˆ ì¤„ì´ë‚˜ í—¤ë”ê°€ ì¶”ì¶œë˜ì—ˆì„ ê²½ìš° ì¬ì‹œë„
          if [ -z "$BRANCH_NAME" ] || [[ "$BRANCH_NAME" == "###"* ]] || [[ "$BRANCH_NAME" == "ğŸŒ³"* ]]; then
            # ë‹¤ë¥¸ íŒ¨í„´ìœ¼ë¡œ ì¬ì‹œë„: "Branch" ë‹¤ìŒ ì²« ë²ˆì§¸ ë¹„ì–´ìˆì§€ ì•Šì€ ì¤„
            BRANCH_NAME=$(sed -n '/Branch/,/###/{/Branch/n; /###/!p;}' issue_body.txt | grep -v "^$" | head -1 | xargs)
          fi

          # ë¸Œëœì¹˜ íƒ€ì… ì¶”ì¶œ
          BRANCH_TYPE=$(grep -A 2 "ë¸Œëœì¹˜ íƒ€ì…\|branchType" issue_body.txt | tail -1 | xargs)

          # ë¹ˆ ì¤„ì´ë‚˜ í—¤ë”ê°€ ì¶”ì¶œë˜ì—ˆì„ ê²½ìš° ì¬ì‹œë„
          if [ -z "$BRANCH_TYPE" ] || [[ "$BRANCH_TYPE" == "###"* ]] || [[ "$BRANCH_TYPE" == "ğŸ“‚"* ]]; then
            BRANCH_TYPE=$(sed -n '/ë¸Œëœì¹˜ íƒ€ì…/,/###/{/ë¸Œëœì¹˜ íƒ€ì…/n; /###/!p;}' issue_body.txt | grep -v "^$" | head -1 | xargs)
          fi

          echo "ì¶”ì¶œëœ ë¸Œëœì¹˜ íƒ€ì…: $BRANCH_TYPE"

          # ì´ìŠˆ ì œëª©ì— ë¸Œëœì¹˜ íƒ€ì… ì¶”ê°€ (ì´ìŠˆ ì œëª©ë§Œ ëŒ€ë¬¸ì)
          if [ -n "$BRANCH_TYPE" ] && [ -n "$ISSUE_TITLE" ]; then
            # ì´ë¯¸ íƒ€ì…ì´ í¬í•¨ë˜ì–´ ìˆì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì¶”ê°€
            if [[ ! "$ISSUE_TITLE" =~ ^\[.*\] ]]; then
              BRANCH_TYPE_UPPER=$(echo "$BRANCH_TYPE" | tr '[:lower:]' '[:upper:]')
              NEW_ISSUE_TITLE="[${BRANCH_TYPE_UPPER}] ${ISSUE_TITLE}"
              echo "ìƒˆë¡œìš´ ì´ìŠˆ ì œëª©: $NEW_ISSUE_TITLE"
            else
              NEW_ISSUE_TITLE="$ISSUE_TITLE"
              echo "ì´ìŠˆ ì œëª©ì— ì´ë¯¸ íƒ€ì…ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
            fi
          else
            NEW_ISSUE_TITLE="$ISSUE_TITLE"
          fi

          if [ -z "$BRANCH_NAME" ]; then
            echo "ë¸Œëœì¹˜ëª…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ ì‚¬ìš©."
            BRANCH_NAME="issue-${{ github.event.issue.number }}"
          else
            # ğŸ”§ Git ë¸Œëœì¹˜ëª… ê·œì¹™ì— ë§ê²Œ ì •ì œ (í•œê¸€ í—ˆìš©)
            # 1. ê³µë°± -> í•˜ì´í”ˆ(-)ìœ¼ë¡œ ë³€ê²½
            BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/ /-/g')

            # 2. Gitì—ì„œ í—ˆìš©í•˜ì§€ ì•ŠëŠ” íŠ¹ìˆ˜ë¬¸ìë§Œ ì œê±° (í•œê¸€ í¬í•¨ ìœ ë‹ˆì½”ë“œ í—ˆìš©)
            # ì œê±° ëŒ€ìƒ: :, ^, ~, ?, *, [, \, .., @{, ì—°ì†ëœ ì  ë“±
            BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[:^~?*\[\\]//g; s/\.\.//g; s/@{//g')

            # 3. ì—°ì†ëœ í•˜ì´í”ˆ/ìŠ¬ë˜ì‹œ ì œê±°
            BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/--*/-/g; s/\/\/*\//\//g')

            # 4. ì•ë’¤ í•˜ì´í”ˆ/ìŠ¬ë˜ì‹œ/ì  ì œê±°
            BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/^[-\/\.]*//; s/[-\/\.]*$//')

            # 5. ë¹ˆ ë¬¸ìì—´ ì²´í¬
            if [ -z "$BRANCH_NAME" ]; then
              echo "ì •ì œ í›„ ë¸Œëœì¹˜ëª…ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ ì‚¬ìš©."
              BRANCH_NAME="issue-${{ github.event.issue.number }}"
            else
              # âœ¨ ë¸Œëœì¹˜ íƒ€ì…ì„ ë¸Œëœì¹˜ëª… ë§¨ ì•ì— ë¶™ì´ê¸°
              if [ -n "$BRANCH_TYPE" ]; then
                # ë¸Œëœì¹˜ëª…ì— ì´ë¯¸ íƒ€ì…ì´ í¬í•¨ë˜ì–´ ìˆì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì¶”ê°€
                if [[ ! "$BRANCH_NAME" =~ ^$BRANCH_TYPE/ ]]; then
                  BRANCH_NAME="${BRANCH_TYPE}/${BRANCH_NAME}"
                fi
              fi

              # âœ¨ ì´ìŠˆë²ˆí˜¸ë¥¼ ë¸Œëœì¹˜ëª… ì•ì— ìë™ìœ¼ë¡œ ë¶™ì´ê¸°
              BRANCH_NAME="${{ github.event.issue.number }}-$BRANCH_NAME"
            fi
          fi

          echo "ìµœì¢… ë¸Œëœì¹˜ëª…: $BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "new_issue_title=$NEW_ISSUE_TITLE" >> $GITHUB_OUTPUT
          echo "branch_type=$BRANCH_TYPE" >> $GITHUB_OUTPUT

          # ì„ì‹œ íŒŒì¼ ì‚­ì œ
          rm -f issue_body.txt

      - name: Update issue title and labels
        run: |
          NEW_TITLE="${{ steps.extract.outputs.new_issue_title }}"
          BRANCH_TYPE="${{ steps.extract.outputs.branch_type }}"

          if [ -n "$NEW_TITLE" ] && [ -n "$BRANCH_TYPE" ]; then
            curl -X PATCH \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }} \
              -d "{\"title\":\"$NEW_TITLE\",\"labels\":[\"$BRANCH_TYPE\"]}"

            echo "ì´ìŠˆ ì œëª© ì—…ë°ì´íŠ¸: $NEW_TITLE"
            echo "ë¼ë²¨ ì„¤ì •: $BRANCH_TYPE"
          fi

      - name: Create branch
        run: |
          BRANCH_NAME="${{ steps.extract.outputs.branch_name }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ê¸°ë³¸ ë¸Œëœì¹˜ì—ì„œ ìƒˆ ë¸Œëœì¹˜ ìƒì„±
          git checkout main
          git pull origin main

          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"

          echo "ë¸Œëœì¹˜ '$BRANCH_NAME' ìƒì„± ì™„ë£Œ"
